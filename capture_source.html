<!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><table><tr><td><pre style="margin: 0; line-height: 125%">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117</pre></td><td><pre style="margin: 0; line-height: 125%"><span style="color: #888888">/*</span>
<span style="color: #888888"> * Object and Motion Detection Test</span>
<span style="color: #888888"> * Ben Overholts</span>
<span style="color: #888888"> * Summer 2013</span>
<span style="color: #888888"> *</span>
<span style="color: #888888"> * This project will test the capability to recognize an object of a certain color</span>
<span style="color: #888888"> * and detect basic motion of this object using ESCAPI.</span>
<span style="color: #888888"> *</span>
<span style="color: #888888"> */</span>

 <span style="color: #FF0000; background-color: #FFAAAA">#</span>include <span style="background-color: #fff0f0">&quot;escapi.h&quot;</span>
 <span style="color: #FF0000; background-color: #FFAAAA">#</span>include <span style="color: #333333">&lt;</span>windows.h<span style="color: #333333">&gt;</span>
 <span style="color: #FF0000; background-color: #FFAAAA">#</span>include <span style="color: #333333">&lt;</span>time.h<span style="color: #333333">&gt;</span>
 <span style="color: #FF0000; background-color: #FFAAAA">#</span>include <span style="color: #333333">&lt;</span>stdio.h<span style="color: #333333">&gt;</span>

 <span style="color: #008800; font-weight: bold">using</span> <span style="color: #008800; font-weight: bold">namespace</span> std;

 <span style="color: #333399; font-weight: bold">int</span> <span style="color: #0066BB; font-weight: bold">main</span> () {

    <span style="color: #888888">/* Initialize ESCAPI */</span>
    <span style="color: #333399; font-weight: bold">int</span> devices <span style="color: #333333">=</span> setupESCAPI();

    <span style="color: #008800; font-weight: bold">if</span> (devices <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">0</span>) {
        printf(<span style="background-color: #fff0f0">&quot;ESCAPI initialization failure or no devices found.</span><span style="color: #666666; font-weight: bold; background-color: #fff0f0">\n</span><span style="background-color: #fff0f0">&quot;</span>);
        <span style="color: #008800; font-weight: bold">return</span> <span style="color: #0000DD; font-weight: bold">1</span>;
    }

    <span style="color: #888888">/* Set up capture parameters */</span>

    <span style="color: #008800; font-weight: bold">struct</span> SimpleCapParams capture;
    capture.mWidth <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">320</span>;
    capture.mHeight <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">240</span>;
    capture.mTargetBuf <span style="color: #333333">=</span> <span style="color: #008800; font-weight: bold">new</span> <span style="color: #333399; font-weight: bold">int</span>[<span style="color: #0000DD; font-weight: bold">320</span> <span style="color: #333333">*</span> <span style="color: #0000DD; font-weight: bold">240</span>];

    <span style="color: #008800; font-weight: bold">if</span> (initCapture(<span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #333333">&amp;</span>capture) <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">0</span>) {
        printf(<span style="background-color: #fff0f0">&quot;Capture failed - device may already be in use.</span><span style="color: #666666; font-weight: bold; background-color: #fff0f0">\n</span><span style="background-color: #fff0f0">&quot;</span>);
        <span style="color: #008800; font-weight: bold">return</span> <span style="color: #0000DD; font-weight: bold">1</span>;
    }

    <span style="color: #333399; font-weight: bold">int</span> runtime_limit <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">1000</span>;
    <span style="color: #333399; font-weight: bold">int</span> movement <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>;
    <span style="color: #333399; font-weight: bold">int</span> red, green, blue;
    <span style="color: #333399; font-weight: bold">int</span> x_bar, y_bar, cnt;
    <span style="color: #333399; font-weight: bold">int</span> x_hist[<span style="color: #0000DD; font-weight: bold">8</span>], y_hist[<span style="color: #0000DD; font-weight: bold">8</span>];
    <span style="color: #333399; font-weight: bold">int</span> entry;

    <span style="color: #888888">/* Run the program for the number of frame caps specified */</span>
    <span style="color: #008800; font-weight: bold">while</span>(runtime_limit<span style="color: #333333">--</span> <span style="color: #333333">&gt;</span> <span style="color: #0000DD; font-weight: bold">0</span>) {

        doCapture(<span style="color: #0000DD; font-weight: bold">0</span>);

        <span style="color: #008800; font-weight: bold">while</span> (isCaptureDone(<span style="color: #0000DD; font-weight: bold">0</span>) <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">0</span>) {
            <span style="color: #888888">/* Waiting for capture.... */</span>
        }

        x_bar <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>;
        y_bar <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>;
        cnt <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>;

        <span style="color: #888888">/* Analyze all pixels in the frame */</span>
        <span style="color: #008800; font-weight: bold">for</span>(<span style="color: #333399; font-weight: bold">int</span> i <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> <span style="color: #0000DD; font-weight: bold">240</span>; i<span style="color: #333333">++</span>) {
            <span style="color: #008800; font-weight: bold">for</span>(<span style="color: #333399; font-weight: bold">int</span> j <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>; j <span style="color: #333333">&lt;</span> <span style="color: #0000DD; font-weight: bold">320</span>; j<span style="color: #333333">++</span>) {
                entry   <span style="color: #333333">=</span> capture.mTargetBuf[i<span style="color: #333333">*</span><span style="color: #0000DD; font-weight: bold">320</span> <span style="color: #333333">+</span> j];
                red     <span style="color: #333333">=</span> (entry <span style="color: #333333">&gt;&gt;</span> <span style="color: #0000DD; font-weight: bold">16</span>) <span style="color: #333333">&amp;</span> <span style="color: #005588; font-weight: bold">0xFF</span>;
                blue    <span style="color: #333333">=</span> (entry <span style="color: #333333">&gt;&gt;</span> <span style="color: #0000DD; font-weight: bold">8</span>) <span style="color: #333333">&amp;</span> <span style="color: #005588; font-weight: bold">0xFF</span>;
                green   <span style="color: #333333">=</span> entry <span style="color: #333333">&amp;</span> <span style="color: #005588; font-weight: bold">0xFF</span>;

                <span style="color: #888888">/*  These values correspond to the color</span>
<span style="color: #888888">                    of the object to be tracked */</span>
                <span style="color: #008800; font-weight: bold">if</span>(red <span style="color: #333333">&gt;</span> <span style="color: #0000DD; font-weight: bold">128</span> <span style="color: #333333">&amp;&amp;</span> green <span style="color: #333333">&lt;</span> <span style="color: #0000DD; font-weight: bold">64</span> <span style="color: #333333">&amp;&amp;</span> blue <span style="color: #333333">&lt;</span> <span style="color: #0000DD; font-weight: bold">64</span>) {
                    y_bar <span style="color: #333333">+=</span> i;
                    x_bar <span style="color: #333333">+=</span> j;
                    cnt<span style="color: #333333">++</span>;
                }
            }
        }

        <span style="color: #008800; font-weight: bold">if</span>(cnt){
            x_bar <span style="color: #333333">=</span> x_bar <span style="color: #333333">/</span> cnt;
            y_bar <span style="color: #333333">=</span> y_bar <span style="color: #333333">/</span> cnt;

            <span style="color: #888888">/*  Printing output to verify that motion detection works */</span>
            movement <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">1</span>;
            <span style="color: #008800; font-weight: bold">if</span>(runtime_limit <span style="color: #333333">&lt;</span> <span style="color: #0000DD; font-weight: bold">990</span>) {
                <span style="color: #008800; font-weight: bold">if</span>(y_bar <span style="color: #333333">-</span> y_hist[<span style="color: #0000DD; font-weight: bold">7</span>] <span style="color: #333333">&gt;</span> <span style="color: #0000DD; font-weight: bold">60</span>)
                    printf(<span style="background-color: #fff0f0">&quot;Downward Swipe Detected</span><span style="color: #666666; font-weight: bold; background-color: #fff0f0">\n</span><span style="background-color: #fff0f0">&quot;</span>);
                <span style="color: #008800; font-weight: bold">else</span> <span style="color: #008800; font-weight: bold">if</span>(y_hist[<span style="color: #0000DD; font-weight: bold">7</span>] <span style="color: #333333">-</span> y_bar <span style="color: #333333">&gt;</span> <span style="color: #0000DD; font-weight: bold">60</span>)
                    printf(<span style="background-color: #fff0f0">&quot;Upward Swipe Detected</span><span style="color: #666666; font-weight: bold; background-color: #fff0f0">\n</span><span style="background-color: #fff0f0">&quot;</span>);
                <span style="color: #008800; font-weight: bold">else</span> <span style="color: #008800; font-weight: bold">if</span>(x_bar <span style="color: #333333">-</span> x_hist[<span style="color: #0000DD; font-weight: bold">7</span>] <span style="color: #333333">&gt;</span> <span style="color: #0000DD; font-weight: bold">60</span>)
                    printf(<span style="background-color: #fff0f0">&quot;Left Swipe Detected</span><span style="color: #666666; font-weight: bold; background-color: #fff0f0">\n</span><span style="background-color: #fff0f0">&quot;</span>);
                <span style="color: #008800; font-weight: bold">else</span> <span style="color: #008800; font-weight: bold">if</span>(x_hist[<span style="color: #0000DD; font-weight: bold">7</span>] <span style="color: #333333">-</span> x_bar <span style="color: #333333">&gt;</span> <span style="color: #0000DD; font-weight: bold">60</span>)
                    printf(<span style="background-color: #fff0f0">&quot;Right Swipe Detected</span><span style="color: #666666; font-weight: bold; background-color: #fff0f0">\n</span><span style="background-color: #fff0f0">&quot;</span>);
                <span style="color: #008800; font-weight: bold">else</span>
                    movement <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>;
            }

            <span style="color: #008800; font-weight: bold">if</span>(movement){
                <span style="color: #008800; font-weight: bold">for</span>(<span style="color: #333399; font-weight: bold">int</span> a <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>; a <span style="color: #333333">&lt;</span> <span style="color: #0000DD; font-weight: bold">8</span>; a<span style="color: #333333">++</span>) {
                    x_hist[a] <span style="color: #333333">=</span> x_bar;
                    y_hist[a] <span style="color: #333333">=</span> y_bar;
                }
            } <span style="color: #008800; font-weight: bold">else</span> {
                <span style="color: #008800; font-weight: bold">for</span>(<span style="color: #333399; font-weight: bold">int</span> a <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">7</span>; a <span style="color: #333333">&gt;</span> <span style="color: #0000DD; font-weight: bold">0</span>; a<span style="color: #333333">--</span>) {
                    x_hist[a] <span style="color: #333333">=</span> x_hist[a<span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">1</span>];
                    y_hist[a] <span style="color: #333333">=</span> y_hist[a<span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">1</span>];
                }
                x_hist[<span style="color: #0000DD; font-weight: bold">0</span>] <span style="color: #333333">=</span> x_bar;
                y_hist[<span style="color: #0000DD; font-weight: bold">0</span>] <span style="color: #333333">=</span> y_bar;
            }
        }
    }

    deinitCapture(<span style="color: #0000DD; font-weight: bold">0</span>);

    <span style="color: #008800; font-weight: bold">return</span> <span style="color: #0000DD; font-weight: bold">0</span>;

 }
</pre></td></tr></table></div>
